<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Robbing Items Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Robbing Items Tracking</h1>
      <p class="text-sm text-gray-600">Filter by Aircraft and System to view entries.</p>
    </header>

    <!-- Login Section -->
    <section id="login-section" class="bg-white rounded-2xl shadow p-6 max-w-md">
      <h2 class="text-lg font-semibold mb-4">Staff Login</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium">Staff ID</label>
          <input id="staff-id" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g. staff01" />
        </div>
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input id="staff-pass" type="password" class="mt-1 w-full border rounded-lg p-2" placeholder="••••" />
        </div>
        <button id="login-btn" class="w-full py-2 rounded-xl bg-black text-white">Login</button>
        <p id="login-msg" class="text-sm text-red-600"></p>
      </div>
    </section>

    <!-- Main App -->
    <section id="app-section" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex flex-wrap gap-3 items-end">
          <div>
            <label class="block text-sm font-medium">Aircraft</label>
            <select id="sel-aircraft" class="mt-1 border rounded-lg p-2 min-w-[12rem]"></select>
          </div>
          <div>
            <label class="block text-sm font-medium">System</label>
            <select id="sel-system" class="mt-1 border rounded-lg p-2 min-w-[12rem]"></select>
          </div>
          <button id="search-btn" class="px-4 py-2 rounded-xl bg-black text-white">Search</button>
          <button id="export-btn" class="px-4 py-2 rounded-xl border">Export CSV</button>
          <div class="ml-auto flex gap-2">
            <button id="clear-btn" class="px-4 py-2 rounded-xl border">Clear</button>
            <button id="logout-btn" class="px-4 py-2 rounded-xl border">Logout</button>
          </div>
        </div>
      </div>

      <div class="mt-4 bg-white rounded-2xl shadow">
        <div class="p-4 flex justify-between items-center">
          <p id="count" class="text-sm text-gray-600">0 results</p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="results-table">
            <thead class="bg-gray-50" id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Pie Chart Section -->
      <div class="mt-6 bg-white rounded-2xl shadow p-6 hidden" id="chart-section">
        <h2 class="text-lg font-semibold mb-2">AJL Status Summary (9M-LNR)</h2>
        <p id="chart-numbers" class="mb-4 text-gray-700 font-medium"></p>
        <canvas id="statusChart" width="400" height="400"></canvas>
      </div>
    </section>
  </div>

<script>
const loginSection=document.getElementById('login-section');
const appSection=document.getElementById('app-section');
const loginBtn=document.getElementById('login-btn');
const loginMsg=document.getElementById('login-msg');
const staffId=document.getElementById('staff-id');
const staffPass=document.getElementById('staff-pass');
const selAircraft=document.getElementById('sel-aircraft');
const selSystem=document.getElementById('sel-system');
const searchBtn=document.getElementById('search-btn');
const exportBtn=document.getElementById('export-btn');
const clearBtn=document.getElementById('clear-btn');
const logoutBtn=document.getElementById('logout-btn');

const API = "";
let chart=null;

// --- Login ---
loginBtn.addEventListener('click', async ()=>{
  const id=staffId.value.trim(), pw=staffPass.value.trim();
  if(!id||!pw){loginMsg.textContent="Enter ID and password";return;}
  try{
    const res=await fetch(API+'/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,password:pw})});
    if(!res.ok){loginMsg.textContent="Login failed";return;}
    const j=await res.json();
    if(j.success){
      loginSection.classList.add('hidden');appSection.classList.remove('hidden');loadMeta();
    } else loginMsg.textContent="Invalid login";
  }catch(e){loginMsg.textContent="Server error";console.error(e);}
});

async function loadMeta(){
  const res=await fetch(API+'/api/meta');
  const j=await res.json();
  selAircraft.innerHTML='<option value="">--All--</option>'+j.aircrafts.map(v=>`<option>${v}</option>`).join('');
  selSystem.innerHTML='<option value="">--All--</option>'+j.systems.map(v=>`<option>${v}</option>`).join('');
}

searchBtn.addEventListener('click', async ()=>{
  const res=await fetch(API+'/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({aircraft:selAircraft.value,system:selSystem.value})});
  const j=await res.json();renderTable(j);updateChart();
});

// --- Export CSV ---
exportBtn.addEventListener('click', ()=>{
  const table=document.getElementById('results-table');
  let csv=[];for(let r of table.rows){let row=[];for(let c of r.cells){row.push('"'+c.textContent.replace(/"/g,'""')+'"')}csv.push(row.join(','));}
  const blob=new Blob([csv.join('\n')],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='export.csv';a.click();URL.revokeObjectURL(url);
});

// --- Clear / Logout ---
clearBtn.addEventListener('click',()=>{
  selAircraft.value="";selSystem.value="";
  document.getElementById('thead').innerHTML="";
  document.getElementById('tbody').innerHTML="";
  document.getElementById('count').textContent="0 results";
  document.getElementById('chart-section').classList.add('hidden');
});
logoutBtn.addEventListener('click',()=>{
  appSection.classList.add('hidden');
  loginSection.classList.remove('hidden');
  staffId.value="";staffPass.value="";
});

// --- Render grouped table ---
function renderTable(data){
  const thead=document.getElementById('thead');
  const tbody=document.getElementById('tbody');
  const count=document.getElementById('count');
  thead.innerHTML='';tbody.innerHTML='';
  count.textContent=`${data.count} results`;
  if(!data.columns||!data.rows) return;

  const trh=document.createElement('tr');
  data.columns.forEach(c=>{
    const th=document.createElement('th');
    th.className='px-4 py-2 border bg-gray-50';
    th.textContent=c;trh.appendChild(th);
  });
  thead.appendChild(trh);

  const groups={};
  data.rows.forEach(r=>{
    const ajl=r['AJL/DMI']||'';
    if(!groups[ajl]) groups[ajl]=[];
    groups[ajl].push(r);
  });

  Object.keys(groups).forEach(ajl=>{
    const rows=groups[ajl];
    const rowspan=rows.length;
    const ajlStatus=rows[0]['Status'] || 'OPEN';

    rows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      data.columns.forEach(c=>{
        const td=document.createElement('td');
        td.className='px-4 py-2 border';

        if(c==='NO' && i===0){
          td.rowSpan=rowspan;td.textContent=r['NO'];
        }
        else if(c==='AJL/DMI' && i===0){
          td.rowSpan=rowspan;
          td.innerHTML=`<div>${r['AJL/DMI']}</div>
            <div class="mt-2 flex items-center gap-2">
              <input type="checkbox" id="ajl-${ajl}" ${ajlStatus==='CLOSED'?'checked':''} disabled>
              <label id="ajl-label-${ajl}" for="ajl-${ajl}">${ajlStatus}</label>
            </div>`;
        }
        else if(c==='BOOK' && i===0){
          td.rowSpan=rowspan;td.textContent=r['BOOK']??'';
        }
        else if(c==='DEFECT/TASK' && i===0){
          td.rowSpan=rowspan;td.textContent=r['DEFECT/TASK']??'';
        }
        else if(c==='SPARES'){
          td.innerHTML=`
            <div class="flex items-center gap-2">
              <span>${r[c] ?? ''}</span>
              <button class="toggle-btn w-4 h-4 rounded-full bg-red-500" data-ajl="${ajl}"></button>
            </div>`;
        }
        else{
          if(i===0 || (c!=='NO'&&c!=='AJL/DMI'&&c!=='BOOK'&&c!=='DEFECT/TASK')){
            td.textContent=r[c]??'';
          } else return;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });

  document.querySelectorAll('.toggle-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      btn.classList.toggle('bg-red-500');
      btn.classList.toggle('bg-green-500');
      checkGroupStatus(btn.dataset.ajl);
    });
  });
}

// --- Enable AJL checkbox only when all spares are green ---
function checkGroupStatus(ajl){
  const buttons=document.querySelectorAll(`.toggle-btn[data-ajl="${ajl}"]`);
  const allGreen=[...buttons].every(b=>b.classList.contains('bg-green-500'));
  const checkbox=document.getElementById(`ajl-${ajl}`);
  const label=document.getElementById(`ajl-label-${ajl}`);
  if(checkbox && label){
    if(allGreen){
      checkbox.disabled=false;
    } else {
      checkbox.disabled=true;
      checkbox.checked=false;
      label.textContent="OPEN";
    }
  }
}

// --- Checkbox change: update server + chart ---
document.addEventListener('change',async(e)=>{
  if(e.target.matches('input[type="checkbox"][id^="ajl-"]')){
    const ajl=e.target.id.replace('ajl-','');
    const label=document.getElementById(`ajl-label-${ajl}`);
    const newStatus=e.target.checked?"CLOSED":"OPEN";
    if(label) label.textContent=newStatus;
    try{
      await fetch(API+'/api/update-status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ajl,status:newStatus})});
      updateChart();
    }catch(err){console.error('Failed to update status',err);}
  }
});

// --- Chart update ---
async function updateChart(){
  try{
    const res=await fetch(API+'/api/status-summary');
    const data=await res.json();

    document.getElementById('chart-numbers').textContent =
      `Open: ${data.open} | Closed: ${data.closed}`;

    const ctx=document.getElementById('statusChart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'pie',
      data:{labels:['OPEN','CLOSED'],datasets:[{data:[data.open,data.closed],backgroundColor:['#f87171','#34d399']}]},
      options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });
    document.getElementById('chart-section').classList.remove('hidden');
  }catch(e){console.error('Chart load error',e);}
}
</script>
</body>
</html>







